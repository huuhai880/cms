SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AFF_POLICYCOMMISION_APPLY_CreateOrUpdate_AdminWeb]
    @MEMBERID BIGINT = 0,
    @POLICYCOMMISIONIDS VARCHAR(1000) = NULL,
    @CREATEDUSER VARCHAR(20) = NULL
AS 
BEGIN

    --INSERT LOG
    INSERT INTO AFF_POLICYCOMMISION_APPLY_LOG
    (
        ID,
        MEMBERID,
        POLICYCOMMISIONID,
        ISACTIVE,
        CREATEDUSER,
        CREATEDDATE,
        UPDATEDUSER,
        UPDATEDDATE,
        ISDELETED,
        DELETEDUSER,
        DELETEDDATE,
        TYPE,
        COMISSIONVALUE,
        LOGDATE,
        LOGEDUSER
    )
    SELECT 
            ID,
            MEMBERID,
            POLICYCOMMISIONID,
            ISACTIVE,
            CREATEDUSER,
            CREATEDDATE,
            UPDATEDUSER,
            UPDATEDDATE,
            ISDELETED,
            DELETEDUSER,
            DELETEDDATE,
            1, --1: %
            COMISSIONVALUE,
            GETDATE(),
            CREATEDUSER
    FROM    AFF_POLICYCOMMISION_APPLY
    WHERE   AFF_POLICYCOMMISION_APPLY.MEMBERID = @MEMBERID

    --XOA DU LIEU CU
    DELETE AFF_POLICYCOMMISION_APPLY
    WHERE  MEMBERID = @MEMBERID

    --THEM MOI CHINH SACH
    INSERT INTO AFF_POLICYCOMMISION_APPLY
    (
        MEMBERID,
        POLICYCOMMISIONID,
        ISACTIVE,
        CREATEDDATE,
        CREATEDUSER,
        ISDELETED
    )
    SELECT 
            @MEMBERID,
            CAST(ITEM AS BIGINT),
            1,
            GETDATE(),
            @CREATEDUSER,
            0
    FROM    dbo.split(@POLICYCOMMISIONIDS, ',')

END
GO
