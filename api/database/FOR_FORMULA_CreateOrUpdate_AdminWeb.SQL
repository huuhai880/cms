SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<locnd>
-- Create date: <28/09/2021>
-- Description:	<thêm mới và chỉnh sửa công thức>
-- =============================================
ALTER PROCEDURE [dbo].[FOR_FORMULA_CreateOrUpdate_AdminWeb]
	@FORMULAID BIGINT = NULL,
	@FORMULANAME NVARCHAR(MAX) = NULL,
	@ATTRIBUTESGROUPID BIGINT = NULL,
    @DESCRIPTION NVARCHAR(MAX) = NULL,
	@ORTHERID1 BIGINT = NULL,
	@ORTHERID2 BIGINT = NULL,
	@ISFOMULAORTHERID1 BIT = NULL,
	@ISFOMULAORTHERID2 BIT = NULL,
	@CALCULATIONID BIGINT = NULL,
	@ISDEFAULT BIT,
    @ISACTIVE BIT,
	@ORDERINDEX NVARCHAR(50),
    @CREATEDUSER NVARCHAR(50),
    @ISTOTALNOSHORTENED BIT  = 0,
    @ISTOTALSHORTENED BIT  = 0,
    @ISTOTAL2DIGIT BIT  = 0,
    @ISCONDITIONFORMULA BIT = 0,
    @ISCOUPLEFORMULA BIT = 0,
    @REFFORMULAID BIGINT = NULL,
    @REFCONDITIONID BIGINT = NULL,
    @INTERPRETFORMULAID BIGINT = NULL
AS
BEGIN

	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	IF NOT EXISTS (SELECT 1 FROM FOR_FORMULA WHERE FORMULAID = @FORMULAID)--insert
	BEGIN
		INSERT INTO FOR_FORMULA
        ( 
                FORMULANAME,
                ATTRIBUTESGROUPID,
                DESCRIPTION,
                ORDERINDEX,
                ISFOMULAORTHERID1,
                ISFOMULAORTHERID2,
                ORTHERID1,
                ORTHERID2,
                CALCULATIONID,
                ISDEFAULT,
                ISACTIVE,
                CREATEDUSER,
                CREATEDDATE,
                ISDELETED,
                ISTOTALNOSHORTENED,
                ISTOTALSHORTENED,
                ISTOTAL2DIGIT,
                ISCONDITIONFORMULA,
                ISCOUPLEFORMULA,
                REFFORMULAID,
                REFCONDITIONID,
                INTERPRETFORMULAID
        )
		VALUES  
        (  
                @FORMULANAME,
                @ATTRIBUTESGROUPID,
                @DESCRIPTION,
                @ORDERINDEX,
                @ISFOMULAORTHERID1,
                @ISFOMULAORTHERID2,
                @ORTHERID1,
                @ORTHERID2,
                @CALCULATIONID,
                @ISDEFAULT,
                @ISACTIVE,
                @CREATEDUSER,
                GETDATE(),
                0,
                @ISTOTALNOSHORTENED,
                @ISTOTALSHORTENED,
                @ISTOTAL2DIGIT,
                @ISCONDITIONFORMULA,
                @ISCOUPLEFORMULA,
                @REFFORMULAID,
                @REFCONDITIONID,
                @INTERPRETFORMULAID
        )
        SET @FORMULAID = SCOPE_IDENTITY()
        SELECT @FORMULAID AS RESULT
    end
	ELSE
    BEGIN --update
			UPDATE      FOR_FORMULA SET
						FORMULANAME= ISNULL(@FORMULANAME, FORMULANAME),
						ATTRIBUTESGROUPID= ISNULL(@ATTRIBUTESGROUPID, ATTRIBUTESGROUPID),
						DESCRIPTION= ISNULL(@DESCRIPTION, DESCRIPTION),
						ORDERINDEX= ISNULL(@ORDERINDEX, ORDERINDEX),
						ISFOMULAORTHERID1= ISNULL(@ISFOMULAORTHERID1, ISFOMULAORTHERID1),
						ISFOMULAORTHERID2= ISNULL(@ISFOMULAORTHERID2, ISFOMULAORTHERID2),
						ORTHERID1= ISNULL(@ORTHERID1,ORTHERID1),
						ORTHERID2= ISNULL(@ORTHERID2,ORTHERID2),
						CALCULATIONID= ISNULL(@CALCULATIONID, CALCULATIONID),
						ISDEFAULT= ISNULL(@ISDEFAULT, ISDEFAULT),
						ISACTIVE= ISNULL(@ISACTIVE, ISACTIVE),
						UPDATEDUSER = ISNULL(@CREATEDUSER, UPDATEDUSER),
						UPDATEDDATE = GETDATE(),
						ISDELETED = 0,
                        ISTOTALNOSHORTENED = @ISTOTALNOSHORTENED,
                        ISTOTALSHORTENED = @ISTOTALSHORTENED,
                        ISTOTAL2DIGIT = @ISTOTAL2DIGIT,
                        ISCONDITIONFORMULA = @ISCONDITIONFORMULA,
                        ISCOUPLEFORMULA = @ISCOUPLEFORMULA,
                        REFFORMULAID = @REFFORMULAID,
                        REFCONDITIONID = @REFCONDITIONID,
                        INTERPRETFORMULAID = @INTERPRETFORMULAID
			WHERE       @FORMULAID = FORMULAID

		    SELECT @FORMULAID AS RESULT
    END
END
GO
