SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AFF_AFFILIATE_GetById_AdminWeb] 
    @AFFILIATEID BIGINT = 9
AS 
BEGIN

    --THONG TIN AFFILIATE
    SELECT 
            AFF_AFFILIATE.AFFILIATEID,
            AFF_AFFILIATE.MEMBERID,
            CRM_ACCOUNT.CUSTOMERCODE,
            AFF_AFFILIATE.MEMBERID AS VALUE,
            CONCAT(CRM_ACCOUNT.CUSTOMERCODE, ' - ', CRM_ACCOUNT.FULLNAME) AS LABEL,
            CRM_ACCOUNT.FULLNAME,
            CRM_ACCOUNT.EMAIL,
            AFF_AFFILIATE.PHONENUMBER,
            AFF_AFFILIATE.PROVINCEID,
            AFF_AFFILIATE.DISTRICTID,
            AFF_AFFILIATE.WARDID,
            AFF_AFFILIATE.ADDRESS,
            IIF(CRM_ACCOUNT.BIRTHDAY IS NOT NULL, FORMAT(CRM_ACCOUNT.BIRTHDAY, 'dd/MM/yyyy'), '') BIRTHDAY,
            AFF_AFFILIATE.IDCARD,
            AFF_AFFILIATE.IDCARDBACKSIDE,
            AFF_AFFILIATE.IDCARDFRONTSIDE,
            AFF_AFFILIATE.LIVEIMAGE,
            IIF(AFF_AFFILIATE.IDCARDDATE IS NOT NULL, FORMAT(AFF_AFFILIATE.IDCARDDATE, 'dd/MM/yyyy'), '') IDCARDDATE,
            AFF_AFFILIATE.IDCARDPLACE,
            AFF_AFFILIATE.AFFILIATETYPEID,
            AFF_AFFILIATE.ISAGREE,
            IIF(AFF_AFFILIATE.REGISTRATIONDATE IS NOT NULL, FORMAT(AFF_AFFILIATE.REGISTRATIONDATE, 'dd/MM/yyyy HH:mm:ss'), '') REGISTRATIONDATEVIEW,
            AFF_AFFILIATE.ISACTIVE,
            AFF_AFFILIATETYPE.AFFILIATETYPENAME,
            AFF_AFFILIATETYPE.ISAFFILIATELEVEL2,
            AFF_AFFILIATETYPE.ISAFFILIATELEVEL1,
            IIF(AFF_AFFILIATE.APPROVEDDATE IS NOT NULL, FORMAT(AFF_AFFILIATE.APPROVEDDATE, 'dd/MM/yyyy HH:mm:ss'), '') APPROVEDDATEVIEW

    FROM    AFF_AFFILIATE

    JOIN    CRM_ACCOUNT
    ON      CRM_ACCOUNT.MEMBERID = AFF_AFFILIATE.MEMBERID
    AND     CRM_ACCOUNT.ISACTIVE = 1
    AND     CRM_ACCOUNT.ISDELETED = 0

    JOIN    AFF_AFFILIATETYPE
    ON      AFF_AFFILIATETYPE.AFFILIATETYPEID = AFF_AFFILIATE.AFFILIATETYPEID
    AND     AFF_AFFILIATETYPE.ISACTIVE = 1
    AND     AFF_AFFILIATETYPE.ISDELETED = 0

    WHERE   AFF_AFFILIATE.AFFILIATEID = @AFFILIATEID
    AND     AFF_AFFILIATE.ISDELETED = 0;

    --DANH SACH CHINH SACH CUA AFF
    SELECT 
            AFF_POLICYCOMMISION_APPLY.POLICYCOMMISIONID value,
            POLICYCOMMISIONNAME label
    FROM    AFF_POLICYCOMMISION_APPLY

    JOIN    AFF_POLICYCOMMISION
    ON      AFF_POLICYCOMMISION.POLICYCOMMISIONID = AFF_POLICYCOMMISION_APPLY.POLICYCOMMISIONID
    AND     AFF_POLICYCOMMISION.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION.ISDELETED = 0

    WHERE   AFF_POLICYCOMMISION_APPLY.MEMBERID IN 
            (
                SELECT MEMBERID 
                FROM AFF_AFFILIATE 
                WHERE AFF_AFFILIATE.AFFILIATEID = @AFFILIATEID
            )
    AND     AFF_POLICYCOMMISION_APPLY.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION_APPLY.ISDELETED = 0;

    --LAY LEADER CUA MEMBER NEU CO
    SELECT 
            TOP 1
            AFF_RELATIONSHIPS.REFMEMBERID AS affiliate_leader_id,
            CRM_ACCOUNT.CUSTOMERCODE,
            AFF_RELATIONSHIPS.REFMEMBERID VALUE,
            CONCAT(CRM_ACCOUNT.CUSTOMERCODE, ' - ',  CRM_ACCOUNT.FULLNAME) LABEL
    FROM    AFF_RELATIONSHIPS

    JOIN    CRM_ACCOUNT
    ON      CRM_ACCOUNT.MEMBERID = AFF_RELATIONSHIPS.REFMEMBERID
    AND     CRM_ACCOUNT.ISACTIVE = 1
    AND     CRM_ACCOUNT.ISDELETED = 0

    WHERE   AFF_RELATIONSHIPS.MEMBERID IN 
            (
                SELECT MEMBERID 
                FROM AFF_AFFILIATE 
                WHERE AFF_AFFILIATE.AFFILIATEID = @AFFILIATEID
            )
    AND     AFF_RELATIONSHIPS.[LEVEL] = 2

END
GO
