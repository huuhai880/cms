SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SL_RECEIPTS_Create_AdminWeb]
    @ORDERID BIGINT = 0,
    @MEMBERID BIGINT = 0,
    @TOTALMONEY MONEY = 0,
    @TOTALPAID MONEY = 0,
    @CREATEDUSER VARCHAR(100) = NULL
AS
BEGIN

    DECLARE @RECEIPTNO VARCHAR(50) = NULL;
    DECLARE @RECEIPTNO_MAX BIGINT = NULL;

    SELECT @RECEIPTNO_MAX = MAX(CAST(RIGHT(RECEIPTNO,8) AS BIGINT))
    FROM    SL_RECEIPTS
    WHERE   SL_RECEIPTS.CREATEDDATE >= CAST(GETDATE() AS DATE)
    AND     SL_RECEIPTS.CREATEDDATE < CAST(GETDATE() + 1 AS DATE)

    IF(@RECEIPTNO_MAX IS NULL OR @RECEIPTNO_MAX = 0)
        SET @RECEIPTNO_MAX = 1
    ELSE 
        SET @RECEIPTNO_MAX = @RECEIPTNO_MAX + 1;

    SET @RECEIPTNO = CONCAT('PT', FORMAT(GETDATE(), 'yyyyMMdd'), RIGHT(CONCAT('00000000', @RECEIPTNO_MAX),8))

    INSERT INTO SL_RECEIPTS
    (
        MEMBERID,
        RECEIPTNO,
        ORDERID,
        TOTALMONEY,
        TOTALPAID,
        NOTE,
        PAYMENTMETHODID,
        BANKCODE,
        ORDERPAYMENTTRANSID,
        CREATEDDATE,
        CREATEDUSER,
        ISDELETED
    )
    VALUES
    (
        @MEMBERID,
        @RECEIPTNO,
        @ORDERID,
        @TOTALMONEY,
        @TOTALPAID,
        N'Thanh toán từ tạo đơn hàng trên Portal',
        2,--THANH TOAN PORTAL
        NULL,
        NULL,
        GETDATE(),
        @CREATEDUSER,
        0
    );

    --INSERT HISTORY
    EXECUTE CUS_SEARCH_HISTORY_Create_Web @ORDERID=@ORDERID

    --INSERT MEMBERSHIP
    EXECUTE CRM_MEMBERSHIPS_Create_AdminWeb @ORDERID=@ORDERID,@CREATEDUSER=@CREATEDUSER

END
GO
