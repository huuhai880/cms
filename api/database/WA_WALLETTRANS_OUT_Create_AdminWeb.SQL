CREATE PROCEDURE WA_WALLETTRANS_OUT_Create_AdminWeb
    @WDREQUESTID BIGINT = 0,
    @PAYMENTIMAGE VARCHAR(1000) = NULL,
    @CREATEDUSER VARCHAR(50) = NULL
AS 
BEGIN

    DECLARE @WALLETTRANSOUTCODE AS VARCHAR(50) = NULL;
    DECLARE @WALLETTRANSOUTCODE_MAX BIGINT = NULL;

    SELECT  @WALLETTRANSOUTCODE_MAX = MAX(CAST(RIGHT(WALLETTRANSOUTCODE,3) AS BIGINT))
    FROM    WA_WALLETTRANS_OUT
    WHERE   WA_WALLETTRANS_OUT.CREATEDDATE >= CAST(GETDATE() AS DATE)
    AND     WA_WALLETTRANS_OUT.CREATEDDATE < CAST(GETDATE() + 1 AS DATE)

    IF(@WALLETTRANSOUTCODE_MAX IS NULL OR @WALLETTRANSOUTCODE_MAX = 0)
        SET @WALLETTRANSOUTCODE_MAX = 1
    ELSE 
        SET @WALLETTRANSOUTCODE_MAX = @WALLETTRANSOUTCODE_MAX + 1;

    SET @WALLETTRANSOUTCODE = CONCAT('RT', FORMAT(GETDATE(), 'yyyyMMdd'), '-', RIGHT(CONCAT('00', @WALLETTRANSOUTCODE_MAX),3));

    DECLARE @MEMBERID AS BIGINT = 0;
    DECLARE @WALLETID AS BIGINT = 0;
    DECLARE @TRANSVALUE AS MONEY = 0;
    DECLARE @BANKACCOUNTID AS BIGINT = 0;

    SELECT  @MEMBERID = MEMBERID,
            @TRANSVALUE = WDVALUES,
            @BANKACCOUNTID = BANKACCOUNTID
    FROM    WA_WITHDRAWREQUEST 
    WHERE   WDREQUESTID = @WDREQUESTID
    AND     ISACTIVE = 1 
    AND     ISDELETED = 0


    SET @MEMBERID = (SELECT MEMBERID FROM WA_WITHDRAWREQUEST WHERE WDREQUESTID = @WDREQUESTID AND ISACTIVE = 1 AND ISDELETED = 0);
    SET @WALLETID = (SELECT WALLETID FROM WA_WALET WHERE MEMBERID = @MEMBERID AND ISACTIVE = 1 AND ISDELETED = 0);

    INSERT INTO WA_WALLETTRANS_OUT
    (
        WALLETID,
        MEMBERID,
        WALLETTRANSOUTCODE,
        PAYMENTIMAGE,
        BANKACCOUNTID,
        TRANSVALUE,
        [DESCRIPTION],
        ISACTIVE,
        CREATEDDATE,
        CREATEDUSER,
        ISDELETED,
        WDREQUESTID
    )
    VALUES
    ( 
        @WALLETID,
        @MEMBERID,
        @WALLETTRANSOUTCODE,
        @PAYMENTIMAGE,
        @BANKACCOUNTID,
        @TRANSVALUE,
        N'Rút tiền từ ví về ngân hàng',
        1,
        GETDATE(),
        @CREATEDUSER,
        0,
        @WDREQUESTID
    );

    --TRU TIEN TU VI
    --INSERT HISTORY VI
    INSERT INTO WA_WALLET_HISTORY
    (
        WALLETID,
        MEMBERID,
        AVAILABLEBALANCE,
        TOTALACCUMULATEDMONEY,
        TOTALWITHDRAW,
        ISACTIVE,
        ISDELETED,
        CREATEDUSER,
        CREATEDDATE,
        UPDATEDUSER,
        UPDATEDDATE,
        DELETEDUSER,
        DELETEDDATE
    )
    SELECT 
            WALLETID,
            MEMBERID,
            AVAILABLEBALANCE,
            TOTALACCUMULATEDMONEY,
            TOTALWITHDRAW,
            ISACTIVE,
            ISDELETED,
            CREATEDUSER,
            CREATEDDATE,
            UPDATEDUSER,
            UPDATEDDATE,
            DELETEDUSER,
            DELETEDDATE
    FROM    WA_WALET
    WHERE   MEMBERID = @MEMBERID;

    --TRU SO TIEN DA RUT
    UPDATE  WA_WALET
    SET     UPDATEDUSER = @CREATEDUSER,
            UPDATEDDATE = GETDATE(),
            TOTALWITHDRAW = TOTALWITHDRAW + @TRANSVALUE,
            AVAILABLEBALANCE = AVAILABLEBALANCE - @TRANSVALUE
    WHERE   MEMBERID = @MEMBERID;

END