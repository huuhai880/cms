CREATE PROCEDURE AFF_AFFILIATE_UpLevel_AdminWeb
    @MEMBERIDS VARCHAR(2000) = NULL,
    @UPDATEDUSER VARCHAR(20) = NULL
AS 
BEGIN

    --LAY AFFILIATETYPE LEADER
    DECLARE @AFFILIATETYPEID BIGINT = 0;
    SELECT TOP 1 @AFFILIATETYPEID = AFFILIATETYPEID 
    FROM    AFF_AFFILIATETYPE
    WHERE   AFF_AFFILIATETYPE.ISACTIVE = 1
    AND     AFF_AFFILIATETYPE.ISDELETED = 0
    AND     AFF_AFFILIATETYPE.ISAFFILIATELEVEL2 = 1


    --UPDATE AFFILIATETYPE
    UPDATE  AFF_AFFILIATE
    SET     UPDATEDDATE = GETDATE(),
            UPDATEDUSER = @UPDATEDUSER,
            AFFILIATETYPEID = @AFFILIATETYPEID
    WHERE   MEMBERID IN (SELECT CAST(ITEM AS BIGINT) FROM dbo.split(@MEMBERIDS, ','))
    AND     ISDELETED = 0;

    --ADD RELATIONSHIP
    INSERT INTO AFF_RELATIONSHIPS(MEMBERID, REFMEMBERID, [LEVEL], CREATEDDATE)
    SELECT 
            CAST(ITEM AS BIGINT),
            0,
            1,
            GETDATE()
    FROM    dbo.split(@MEMBERIDS, ',')
END