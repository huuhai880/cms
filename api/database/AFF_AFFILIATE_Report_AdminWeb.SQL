SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AFF_AFFILIATE_Report_AdminWeb]
    @MEMBERID BIGINT = 7,
    @MONTH VARCHAR(20) = NULL
AS 
BEGIN

    DECLARE @MONTH_D AS DATETIME = GETDATE();
    IF(ISNULL(@MONTH,'') <> '') SET @MONTH_D = TRY_CONVERT(DATETIME, @MONTH, 103);

    DECLARE @FIRSTDATEOFMONTH DATETIME, @LASTDATEOFMONTH DATETIME

    SET @FIRSTDATEOFMONTH = (SELECT CONVERT(DATE,DATEADD(dd,-(DAY(@MONTH_D)-1),@MONTH_D)) )
    SET @LASTDATEOFMONTH = (SELECT DATEADD(s,-1,DATEADD(mm,DATEDIFF(m,0,@MONTH_D)+1,0))) 

    SELECT 
        SUM(TB_TOTAL.TOTALORDER) TOTALORDER,
        SUM(TB_TOTAL.TOTALREVENUE) TOTALREVENUE,
        SUM(TB_TOTAL.TOTALCOMMISION) TOTALCOMMISION
    FROM
    (
        SELECT 
                COUNT(1) AS TOTALORDER,
                0 TOTALREVENUE,
                0 TOTALCOMMISION
        FROM    SL_ORDER
        WHERE   SL_ORDER.ISDELETED = 0
        AND     SL_ORDER.ISACTIVE = 1
        AND     SL_ORDER.[STATUS] = 1
        AND     SL_ORDER.REFERRALCODE = @MEMBERID
        AND     SL_ORDER.ORDERDATE >= @FIRSTDATEOFMONTH
        AND     SL_ORDER.ORDERDATE < @LASTDATEOFMONTH

        UNION
        
        SELECT 
                0 TOTALORDER,
                SUM(TOTALREVENUE) TOTALREVENUE,
                SUM(COMISSIONVALUE) TOTALCOMMISION
            
        FROM    AFF_COMISSION
        WHERE   AFF_COMISSION.MEMBERID = @MEMBERID
        AND     AFF_COMISSION.MONTH = MONTH(@MONTH_D)
        AND     AFF_COMISSION.YEAR = YEAR(@MONTH_D)
        AND     (
                    AFF_COMISSION.ISAPPLY = 1
                    OR (
                        AFF_COMISSION.ISCURRENT = 1
                        AND AFF_COMISSION.ISACTIVE = 1
                        AND AFF_COMISSION.ISAPPLY = 0
                    )
                )
    ) AS TB_TOTAL
       




END
GO
