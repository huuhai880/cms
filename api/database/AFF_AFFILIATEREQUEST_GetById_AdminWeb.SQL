ALTER PROCEDURE AFF_AFFILIATEREQUEST_GetById_AdminWeb
    @AFFILIATEREQUESTID BIGINT = 0
AS 
BEGIN

    SELECT 
            AFF_AFFILIATEREQUEST.AFFILIATEREQUESTID,
            AFF_AFFILIATEREQUEST.REQUESTNO,
            AFF_AFFILIATEREQUEST.MEMBERID,
            AFF_AFFILIATEREQUEST.REQUESTSTATUS,
            AFF_AFFILIATEREQUEST.ISAGREE,
            FORMAT(AFF_AFFILIATEREQUEST.REGISTRATIONDATE, 'dd/MM/yyyy HH:mm:ss') REGISTRATIONDATEVIEW,
            IIF(AFF_AFFILIATEREQUEST.APPROVEDDATE IS NOT NULL, FORMAT(AFF_AFFILIATEREQUEST.APPROVEDDATE, 'dd/MM/yyyy HH:mm:ss'), '') APPROVEDDATEVIEW,
            AFF_AFFILIATEREQUEST.REVIEWUSER,
            AFF_AFFILIATEREQUEST.REVIEWNOTE,
            AFF_AFFILIATEREQUEST.LIVEIMAGE,
            AFF_AFFILIATEREQUEST.IDCARDBACKSIDE,
            AFF_AFFILIATEREQUEST.IDCARDFRONTSIDE,
            AFF_AFFILIATEREQUEST.PHONENUMBER,
            AFF_AFFILIATEREQUEST.AFFILIATETYPEID,
            CRM_ACCOUNT.CUSTOMERCODE,
            CONCAT(CRM_ACCOUNT.CUSTOMERCODE, '-', CRM_ACCOUNT.FULLNAME) FULLNAME,
            AFF_AFFILIATETYPE.AFFILIATETYPENAME,
            CRM_ACCOUNT.EMAIL,
            AFF_AFFILIATEREQUEST.IDCARD,
            AFF_AFFILIATEREQUEST.IDCARDPLACE,
            IIF(AFF_AFFILIATEREQUEST.IDCARDDATE IS NOT NULL, FORMAT(AFF_AFFILIATEREQUEST.IDCARDDATE, 'dd/MM/yyyy'), '') IDCARDDATE,
            AFF_AFFILIATEREQUEST.PROVINCEID,
            AFF_AFFILIATEREQUEST.DISTRICTID,
            AFF_AFFILIATEREQUEST.WARDID,
            AFF_AFFILIATEREQUEST.ADDRESS,
            IIF(CRM_ACCOUNT.BIRTHDAY IS NOT NULL, FORMAT(CRM_ACCOUNT.BIRTHDAY, 'dd/MM/yyyy'), '') BIRTHDAY,
            CASE 
                WHEN AFF_AFFILIATEREQUEST.REQUESTSTATUS = 1 THEN N'Yêu cầu đăng ký mới'
                WHEN AFF_AFFILIATEREQUEST.REQUESTSTATUS = 2 THEN N'Thành công'
                WHEN AFF_AFFILIATEREQUEST.REQUESTSTATUS = 3 THEN N'KH Huỷ yêu cầu'
                WHEN AFF_AFFILIATEREQUEST.REQUESTSTATUS = 4 THEN N'Huỷ yêu cầu'
            ELSE '' END REQUESTSTATUSNAME

    FROM    AFF_AFFILIATEREQUEST

    JOIN    CRM_ACCOUNT
    ON      AFF_AFFILIATEREQUEST.MEMBERID = CRM_ACCOUNT.MEMBERID
    AND     CRM_ACCOUNT.ISACTIVE = 1
    AND     CRM_ACCOUNT.ISDELETED = 0

    JOIN    AFF_AFFILIATETYPE
    ON      AFF_AFFILIATETYPE.AFFILIATETYPEID = AFF_AFFILIATEREQUEST.AFFILIATETYPEID
    AND     AFF_AFFILIATETYPE.ISDELETED = 0
    AND     AFF_AFFILIATETYPE.ISACTIVE = 1

    WHERE   AFF_AFFILIATEREQUEST.AFFILIATEREQUESTID = @AFFILIATEREQUESTID
    AND     AFF_AFFILIATEREQUEST.ISDELETED = 0;


    SELECT 
            AFF_AFFILIATETYPE.AFFILIATETYPEID,
            AFF_AFFILIATETYPE.AFFILIATETYPENAME
    FROM    AFF_AFFILIATETYPE
    WHERE   AFF_AFFILIATETYPE.ISACTIVE = 1
    AND     AFF_AFFILIATETYPE.ISDELETED = 0;

    SELECT 
            AFF_POLICYCOMMISION.AFFILIATETYPEID,
            AFF_POLICYCOMMISION.POLICYCOMMISIONID,
            AFF_POLICYCOMMISION.POLICYCOMMISIONNAME,
            AFF_POLICYCOMMISION.ISDEFAULT
    FROM    AFF_POLICYCOMMISION
    WHERE   AFF_POLICYCOMMISION.ISDELETED = 0
    AND     AFF_POLICYCOMMISION.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION.AFFILIATETYPEID IN (
                    SELECT AFFILIATETYPEID 
                    FROM AFF_AFFILIATEREQUEST 
                    WHERE AFFILIATEREQUESTID = @AFFILIATEREQUESTID
                )

    --NEU LA AFF THI SE CO CHINH SACH
    SELECT 
            AFF_POLICYCOMMISION_APPLY.POLICYCOMMISIONID value,
            POLICYCOMMISIONNAME label
    FROM    AFF_POLICYCOMMISION_APPLY

    JOIN    AFF_POLICYCOMMISION
    ON      AFF_POLICYCOMMISION.POLICYCOMMISIONID = AFF_POLICYCOMMISION_APPLY.POLICYCOMMISIONID
    AND     AFF_POLICYCOMMISION.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION.ISDELETED = 0

    WHERE   AFF_POLICYCOMMISION_APPLY.MEMBERID IN 
            (
                SELECT TOP 1 MEMBERID 
                FROM AFF_AFFILIATEREQUEST 
                WHERE AFFILIATEREQUESTID = @AFFILIATEREQUESTID
            )
    AND     AFF_POLICYCOMMISION_APPLY.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION_APPLY.ISDELETED = 0

END