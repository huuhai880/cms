SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AFF_AFFILIATE_GetDataSelect_AdminWeb]
AS 
BEGIN

    --DANH SACH MEMBER
    SELECT 
            CRM_ACCOUNT.MEMBERID,
            CRM_ACCOUNT.CUSTOMERCODE,
            CRM_ACCOUNT.MEMBERID AS VALUE,
            CONCAT(CRM_ACCOUNT.CUSTOMERCODE, ' - ', CRM_ACCOUNT.FULLNAME) AS LABEL,
            CRM_ACCOUNT.FULLNAME,
            CRM_ACCOUNT.EMAIL,
            CRM_ACCOUNT.PHONENUMBER,
            CRM_ACCOUNT.PROVINCEID,
            CRM_ACCOUNT.DISTRICTID,
            CRM_ACCOUNT.WARDID,
            CRM_ACCOUNT.ADDRESS,
            IIF(CRM_ACCOUNT.BIRTHDAY IS NOT NULL, FORMAT(CRM_ACCOUNT.BIRTHDAY, 'dd/MM/yyyy'), '') BIRTHDAY,
            CRM_ACCOUNT.IDCARD,
            CRM_ACCOUNT.IDCARDBACKSIDE,
            CRM_ACCOUNT.IDCARDFRONTSIDE,
            CRM_ACCOUNT.LIVEIMAGE,
            IIF(CRM_ACCOUNT.IDCARDDATE IS NOT NULL, FORMAT(CRM_ACCOUNT.IDCARDDATE, 'dd/MM/yyyy'), '') IDCARDDATE,
            CRM_ACCOUNT.IDCARDPLACE
    FROM    CRM_ACCOUNT
    WHERE   CRM_ACCOUNT.ISACTIVE = 1
    AND     CRM_ACCOUNT.ISDELETED = 0
    AND     CRM_ACCOUNT.MEMBERID NOT IN (SELECT MEMBERID FROM AFF_AFFILIATE WHERE ISDELETED = 0)
    ORDER BY CRM_ACCOUNT.CUSTOMERCODE

    --DANH SACH LOAI THANH VIEN
    SELECT 
            AFF_AFFILIATETYPE.AFFILIATETYPEID,
            AFF_AFFILIATETYPE.AFFILIATETYPENAME,
            AFF_AFFILIATETYPE.ISAFFILIATELEVEL1,
            AFF_AFFILIATETYPE.ISAFFILIATELEVEL2
    FROM    AFF_AFFILIATETYPE
    WHERE   AFF_AFFILIATETYPE.ISACTIVE = 1
    AND     AFF_AFFILIATETYPE.ISDELETED = 0;

     --DANH SACH AFF LEADER
    SELECT 
            AFF_AFFILIATE.MEMBERID VALUE,
            CONCAT(CRM_ACCOUNT.CUSTOMERCODE, ' - ',  CRM_ACCOUNT.FULLNAME) LABEL
    FROM    AFF_AFFILIATE

    JOIN    AFF_AFFILIATETYPE
    ON      AFF_AFFILIATE.AFFILIATETYPEID = AFF_AFFILIATETYPE.AFFILIATETYPEID
    AND     AFF_AFFILIATETYPE.ISAFFILIATELEVEL2 = 1
    AND     AFF_AFFILIATETYPE.ISACTIVE = 1
    AND     AFF_AFFILIATETYPE.ISDELETED = 0

    JOIN    CRM_ACCOUNT
    ON      AFF_AFFILIATE.MEMBERID = CRM_ACCOUNT.MEMBERID
    AND     CRM_ACCOUNT.ISACTIVE = 1
    AND     CRM_ACCOUNT.ISDELETED = 0

    WHERE   AFF_AFFILIATE.ISACTIVE = 1
    AND     AFF_AFFILIATE.ISDELETED = 0
    AND     EXISTS 
                (   SELECT 1 
                    FROM AFF_RELATIONSHIPS 
                    WHERE AFF_RELATIONSHIPS.MEMBERID = AFF_AFFILIATE.MEMBERID
                    AND AFF_RELATIONSHIPS.REFMEMBERID = 0
                    AND AFF_RELATIONSHIPS.[LEVEL] = 1
                )

    --DANH SACH CHINH SACH
    SELECT 
            AFF_POLICYCOMMISION.POLICYCOMMISIONID,
            AFF_POLICYCOMMISION.POLICYCOMMISIONNAME,
            AFF_POLICYCOMMISION.POLICYCOMMISIONID AS VALUE,
            AFF_POLICYCOMMISION.POLICYCOMMISIONNAME AS LABEL,
            AFF_POLICYCOMMISION.ISDEFAULT,
            AFF_POLICYCOMMISION.AFFILIATETYPEID
    FROM    AFF_POLICYCOMMISION
    WHERE   AFF_POLICYCOMMISION.ISACTIVE = 1
    AND     AFF_POLICYCOMMISION.ISDELETED = 0
    

END
GO
