SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<locnd>
-- Create date: <14/09/2021>
-- Description:	<chi tiết đơn hàng>
-- =============================================
ALTER PROCEDURE [dbo].[SL_ORDER_GetbyId_AdminWeb]
    @ORDERID BIGINT = 0
AS
BEGIN

    --1. THONG TIN ORDER
	SELECT 
			    SL_ORDER.ORDERID,
                SL_ORDER.MEMBERID,
			    SL_ORDER.ORDERNO,
			    SL_ORDER.TOTALMONEY,
			    SL_ORDER.STATUS,
			    CONVERT(VARCHAR(10),SL_ORDER.ORDERDATE,103) ORDERDATE,
			    CRM_ACCOUNT.FULLNAME,
			    CRM_ACCOUNT.PHONENUMBER,
			    CRM_ACCOUNT.ADDRESS,
			    CRM_ACCOUNT.EMAIL,
			    SL_ORDER.TOTALDISCOUNT,
			    SL_ORDER.SUBTOTAL,
                SL_ORDER.ISGROWREVENUE,
                SL_ORDER.ORDERTYPE,
                CONCAT(CRM_ACCOUNT.CUSTOMERCODE, ' - ', CRM_ACCOUNT.FULLNAME) CUSTOMERNAME
                

    FROM        SL_ORDER

    JOIN        CRM_ACCOUNT 
    ON          CRM_ACCOUNT.MEMBERID = SL_ORDER.MEMBERID 
    AND         CRM_ACCOUNT.ISACTIVE = 1
    AND         CRM_ACCOUNT.ISDELETED = 0

    WHERE       SL_ORDER.ORDERID = @ORDERID
    AND         SL_ORDER.ISDELETED = 0


    --2. THONG TIN ORDER DETAILS
    SELECT 
                SL_ORDERDETAIL.ORDERDETAILID,
                SL_ORDERDETAIL.ORDERID,
                SL_ORDERDETAIL.PRODUCTID,
                SL_ORDERDETAIL.COMBOID,
                SL_ORDERDETAIL.ISCOMBO,
                SL_ORDERDETAIL.PRICE,
                SL_ORDERDETAIL.QUANTITY,
                SL_ORDERDETAIL.TOTALAMOUNT AS SUBTOTAL,
                IIF(SL_ORDERDETAIL.PRODUCTID IS NOT NULL AND SL_ORDERDETAIL.PRODUCTID <> 0, MD_PRODUCT.PRODUCTNAME, PRO_COMBOS.COMBONAME) PRODUCTNAME,
                IIF(SL_ORDERDETAIL.PRODUCTID IS NOT NULL AND SL_ORDERDETAIL.PRODUCTID <> 0 ,
                    CONCAT(SL_ORDERDETAIL.PRODUCTID,'_0'),
                    CONCAT(SL_ORDERDETAIL.COMBOID,'_1')
                ) TEMPID
    FROM        SL_ORDERDETAIL

    LEFT JOIN   MD_PRODUCT
    ON          MD_PRODUCT.PRODUCTID = SL_ORDERDETAIL.PRODUCTID
    AND         MD_PRODUCT.ISACTIVE = 1
    AND         MD_PRODUCT.ISDELETED = 0
    AND         SL_ORDERDETAIL.ISCOMBO = 0

    LEFT JOIN   PRO_COMBOS
    ON          PRO_COMBOS.COMBOID = SL_ORDERDETAIL.COMBOID
    AND         PRO_COMBOS.ISDELETED = 0
    AND         PRO_COMBOS.ISACTIVE = 1
    AND         SL_ORDERDETAIL.ISCOMBO = 1

    WHERE       SL_ORDERDETAIL.ISDELETED = 0
    AND         SL_ORDERDETAIL.ORDERID = @ORDERID

END
GO