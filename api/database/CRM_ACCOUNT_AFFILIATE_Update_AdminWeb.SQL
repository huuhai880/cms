SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[CRM_ACCOUNT_AFFILIATE_Update_AdminWeb]
    @MEMBERID BIGINT = 0,
    @AFFILIATETYPEID BIGINT = 0,
    @AFFLEADERID BIGINT = 0,
    @PHONENUMBER VARCHAR(20) = NULL,
    @PROVINCEID BIGINT = 0,
    @DISTRICTID BIGINT = 0,
    @WARDID BIGINT = 0,
    @ADDRESS NVARCHAR(200) = NULL,
    @IDCARD VARCHAR(20) = NULL,
    @IDCARDDATE VARCHAR(20) = NULL,
    @IDCARDPLACE NVARCHAR(100) = NULL,
    @IDCARDBACKSIDE VARCHAR(500) = NULL,
    @IDCARDFRONTSIDE VARCHAR(500) = NULL,
    @LIVEIMAGE VARCHAR(500) = NULL,
    @ISAGREE BIT = 0,
    @ISACTIVE BIT = 0,
    @ISMODIFY BIT = 0,
    @UPDATEDUSER VARCHAR(20) = NULL
AS
BEGIN

    DECLARE @IDCARDDATE_UPD AS DATETIME = NULL;
    IF(@IDCARDDATE IS NOT NULL AND @IDCARDDATE <> '')
        SET @IDCARDDATE_UPD = CONVERT(DATETIME,@IDCARDDATE, 103)

    --NEU LA CHINH SUA THI KO UPDATE CAC TRUONG AFFILIATE

    UPDATE  CRM_ACCOUNT
    SET     UPDATEDDATE = GETDATE(),
            UPDATEDUSER = @UPDATEDUSER,
            AFFILIATETYPEID = @AFFILIATETYPEID,
            ISAGREE = @ISAGREE,
            ISACTIVE = @ISACTIVE,
            
            ISAFFILIATE = IIF(@ISMODIFY = 1, ISAFFILIATE, 1), --LA AFFILIATE
            REGISTRATIONDATE = IIF(@ISMODIFY = 1, REGISTRATIONDATE, GETDATE()),
            DATEOFAPPROVAL = IIF(@ISMODIFY = 1, DATEOFAPPROVAL, GETDATE()),
            STATUSAFFILIATE = IIF(@ISMODIFY = 1, STATUSAFFILIATE, 2), -- THANH CONG
            REVIEWUSER = IIF(@ISMODIFY = 1, REVIEWUSER, @UPDATEDUSER),
            REVIEWNOTE = IIF(@ISMODIFY = 1, REVIEWNOTE, N'Tạo đối tác và được duyệt từ Portal'),
            REGISTRATIONSOURCE = IIF(@ISMODIFY = 1, REGISTRATIONSOURCE, 1), --Nguồn đăng ký 1:Portal, 2: Website
            
            PHONENUMBER = @PHONENUMBER,
            PROVINCEID = @PROVINCEID,
            DISTRICTID = @DISTRICTID,
            WARDID = @WARDID,
            ADDRESS = @ADDRESS,
            IDCARD = @IDCARD,
            IDCARDDATE = @IDCARDDATE_UPD,
            IDCARDPLACE = @IDCARDPLACE,
            IDCARDBACKSIDE = @IDCARDBACKSIDE,
            IDCARDFRONTSIDE = @IDCARDFRONTSIDE,
            LIVEIMAGE = @LIVEIMAGE,
            LEADERID = @AFFLEADERID
    WHERE   MEMBERID = @MEMBERID
END
GO
